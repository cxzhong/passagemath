# Ask GAP for the directory where sysinfo.gap lives. This is to
# support system GAP installations. This root-path gathering
# command is borrowed from gap's spkg-configure.m4 and modified
# to separate the paths with spaces.
GAPRUN="gap -r -q --bare --nointeract -c"
_cmd='Display(JoinStringsWithSeparator(GAPInfo.RootPaths," "));'
GAP_ROOT_PATHS=$(${GAPRUN} "${_cmd}")

# Loop though GAP_ROOT_PATHS looking for sysinfo.gap
GAP_ROOT=""
for grp in $GAP_ROOT_PATHS; do
    if [ -f "${grp}/sysinfo.gap" ]; then
        GAP_ROOT=$grp
        echo "found GAP root $GAP_ROOT"
        break
    fi
done

# Try the old sage default if nothing else worked.
if [ -z "$GAP_ROOT" ]; then
    GAP_ROOT="$SAGE_LOCAL/lib/gap"
    echo "falling back to GAP root $GAP_ROOT"
fi

# And finally, throw an error ASAP if the build is going to fail anyway.
if [ ! -f "${GAP_ROOT}/sysinfo.gap" ]; then
    sdh_die "no sysinfo.gap in your gap root"
fi

# Where to install these packages
PKG_DIR="$SAGE_LOCAL/lib/gap/pkg"

BUILDPACKAGES="$(pwd)/src/bin/BuildPackages.sh"

PKG_SRC_DIR="$(pwd)/src/pkg"
cd "$PKG_SRC_DIR"

# directly install pure GAP packages
#
#    happrime - no longer distributed, partly merged in Hap,
#    cf. https://www.gap-system.org/Packages/packages.html#deppkg
#    (GAP 4.8.6 still had it, but this is gone in 4.10)

sdh_install \
    aclib \
    autodoc \
    corelg \
    crime \
    cryst \
    crystcat \
    design \
    gbnp \
    genss \
    hap \
    hapcryst \
    hecke \
    images \
    liealgdb \
    liepring \
    liering \
    lins \
    loops \
    mapclass \
    polymaking \
    qpa \
    quagroup \
    radiroot \
    repsn \
    singular \
    sla \
    sonata \
    toric \
    utils \
    "$PKG_DIR"

install_compiled_pkg()
{
    local pkg="$1"
    # Install the bin/ dir (where compiled modules should end up)
    # under <prefix>/lib/gap; we then symlink to it later
    sdh_install * "$SAGE_LOCAL/lib/gap/pkg/$pkg"

    # TODO:
    # Clean up any build artificts before installing the rest of the package
    # Also remove configure/Makefiles
    # Note: None, if any of the packages really have a proper install target
    #make clean  # Works for some packages but not all
    #rm -rf bin/
    #rm -rf configure configure.* config.* autogen.sh *.m4 Makefile* m4/

}

# Build and install compiled packages:
#
# These packages have an old ./configure that take the GAP_ROOT as a positional
# argument
export CFLAGS="$CFLAGS -Wno-implicit-function-declaration"

"$BUILDPACKAGES" --no-color --with-gaproot "$GAP_ROOT" \
                 --add-package-config-digraphs "--with-external-planarity" \
                 cohomolo crypting grape orb datastructures

for pkg in cohomolo crypting grape orb datastructures
do
    echo "Installing GAP package $pkg"
    cd "$PKG_SRC_DIR/$pkg"
    install_compiled_pkg "$pkg"
    cd "$PKG_SRC_DIR"
done

export CFLAGS="-std=gnu17 $CFLAGS"

"$BUILDPACKAGES" --no-color --with-gaproot "$GAP_ROOT" \
                 --add-package-config-digraphs "--with-external-planarity" \
                 guava

echo "Installing GAP package guava"
cd "$PKG_SRC_DIR/guava"
install_compiled_pkg "guava"
cd "$PKG_SRC_DIR"

# These packages have a new-style autoconf ./configure
# that takes --with-gaproot

"$BUILDPACKAGES" --no-color --with-gaproot "$GAP_ROOT" \
                 --add-package-config-digraphs "--with-external-planarity" \
                 nq io digraphs

for pkg in nq io digraphs
do
    echo "Installing GAP package $pkg"
    cd "$PKG_SRC_DIR/$pkg"
    install_compiled_pkg "$pkg"
    cd "$PKG_SRC_DIR"
done
